parameters:
  - name: VarGroup
    displayName: Variable Group
  - name: Environment
    displayName: Environment to use

trigger: none

pr: none

variables:
  - group: ${{ parameters.VarGroup }}
  - template: /templates/variables.yml

stages:
  - stage: BlaiseInstall_${{parameters.Environment }}
    displayName: ${{parameters.Environment }} Installation Of Blaise
    jobs:
      - deployment: InstallOpsAgent
        displayName: Install Ops Agent
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: blaise
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/opsagent_steps.yml

      - deployment: InstallMySQLConnector
        displayName: Install MySQL .Net Connector
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: blaise
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/mysql_connector_steps.yml
                parameters:
                  GCP_Bucket: $($env:ENV_BLAISE_GCP_BUCKET)

      - deployment: InstallBlaise
        displayName: Install Blaise
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: blaise
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/configure_blaise_steps.yml
              - template: /templates/configure_node_roles_steps.yml
              - template: /templates/firewall_rule_steps.yml
                parameters:
                  RuleName: Blaise
                  InboundPorts: 80, 443, $($env:ENV_BLAISE_CONNECTION_PORT), $($env:ENV_BLAISE_REMOTE_CONNECTION_PORT)
                  OutboundPorts: 80, 443, $($env:ENV_BLAISE_CONNECTION_PORT), $($env:ENV_BLAISE_REMOTE_CONNECTION_PORT)
              - template: /templates/set_environment.yml

      - deployment: ManagementSetup
        displayName: Setup blaise management node
        dependsOn: InstallBlaise
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: mgmt
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/blaise_management_steps.yml

      - deployment: RegisterDataEntryNodes
        condition: eq(variables.ENV_MULTI_NODE, true)
        displayName: Register Data Entry Node
        dependsOn: InstallBlaise
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: data-entry
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/register_node_steps.yml

      - deployment: ConfigureBlaisesDatabases
        displayName: Configure Blaises Sql Databases
        dependsOn: ManagementSetup
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: mgmt
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/configure_blaise_databases.yml


