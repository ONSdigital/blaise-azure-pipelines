parameters:
  - name: VarGroup
    displayName: Variable Group
  - name: Environment
    displayName: Environment to use
  - name: MultiNode
    displayName: Is environment MultiNode (Bool)

trigger: none

pr: none

variables:
  - group: ${{ parameters.VarGroup }}

stages:
  - stage: BlaiseInstall_${{parameters.Environment }}
    displayName: ${{parameters.Environment }} Installation Of Blaise
    jobs:
      - deployment: InstallBlaise
        displayName: Install Blaise
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: blaise
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/configure_blaise_steps.yml
              - template: /templates/configure_node_roles_steps.yml
                condition: eq(variables.MultiNode, true)
              - template: /templates/firewall_rule_steps.yml
                parameters:
                  RuleName: Blaise
                  InboundPorts: 80, 443, $($env:ENV_BLAISE_CONNECTION_PORT), $($env:ENV_BLAISE_REMOTE_CONNECTION_PORT)
                  OutboundPorts: 80, 443, $($env:ENV_BLAISE_CONNECTION_PORT), $($env:ENV_BLAISE_REMOTE_CONNECTION_PORT)

      - deployment: ManagementSetup
        displayName: Setup blaise management node
        dependsOn: InstallBlaise
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: mgmt
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/blaise_management_steps.yml

      - deployment: RegisterDataEntryNodes
        condition: eq(variables.MultiNode, true)
        displayName: Register Data Entry Node
        dependsOn: InstallBlaise
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: data-entry
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/register_node_steps.yml
