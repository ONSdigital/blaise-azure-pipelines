parameters:
  - name: VarGroup
    displayName: Variable Group
  - name: Environment
    displayName: Environment to use

trigger: none

variables:
  - group: ${{ parameters.VarGroup }}
  - template: /templates/variables.yml

stages:
- stage: ConfigureUserRoles_${{parameters.Environment }}
  displayName: ${{parameters.Environment }} Configure User Roles
  variables:
        ENV_RESTAPI_URL: http://localhost:90
        ENV_BLAISE_SERVER_BINDING : $(ENV_BLAISE_INTERNAL_SERVER_BINDING)
  
  jobs:
      - job: CheckUserRolesAlreadyExist
      - deployment: CheckUserRolesAlreadyExist
        displayName: Check User Roles Already Exist
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: restapi
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/check_user_roles_already_exist.yml

      - job: CreateUserRoles
        dependsOn: CheckUserRolesAlreadyExist
        condition: eq(dependencies.CheckUserRolesAlreadyExist.outputs['Deploy_RESTAPI.DoUserRolesExist.UserRolesExist'], 'False') 
      - deployment: CreateUserRoles
        displayName: Create User Roles
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: restapi
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/create_user_roles.yml

      - job: CreateUserRoles
        dependsOn: CreateUserRoles
        condition: eq(dependencies.CreateUserRoles.outputs['Deploy_RESTAPI.DoUserRolesExist.UserRolesExist'], 'False')
      - deployment: CreateUserRoles
        displayName: Create User Roles
        environment:  
          name: ${{parameters.Environment}}
          resourceType: virtualMachine
          tags: restapi
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
              - template: /templates/check_user_roles_were_created.yml