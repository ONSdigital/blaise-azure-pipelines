parameters:
  - name: VarGroup
    displayName: Variable Group
  - name: Environment
    displayName: Environment to use

trigger: none

variables:
  - group: ${{ parameters.VarGroup }}
  - name: InstrumentPath
    value: c:\survey
  - name: ServerParkName
    value: gusty
  - name: InstrumentName
    value: OPN2101A

stages:
  - stage: BlaiseInstall_${{parameters.Environment }}
    displayName: ${{parameters.Environment }} Installation Of Blaise
    jobs:
       - deployment: CheckIfBlaiseIsInstalled
         displayName: Check If Blaise is installed
         environment: ${{parameters.Environment }}.BLAISE-GUSTY-NODE
         strategy:
          runOnce:
             deploy:
               steps:
                - checkout: self

                - task: PowerShell@2
                  inputs:
                    filePath: '$(Agent.BuildDirectory)/s/scripts/Blaise/CheckBlaiseIsInstalled.ps1'
                  name: BlaiseVariables

       - deployment: installBlaise
         displayName: Install Blaise
         environment: ${{parameters.Environment }}.BLAISE-GUSTY-NODE
         dependsOn: CheckIfBlaiseIsInstalled
         condition: eq(dependencies.CheckIfBlaiseIsInstalled.outputs['Deploy_BLAISE-GUSTY-NODE.BlaiseVariables.BlaiseInstalled'], 'False')
         strategy:
          runOnce:
             deploy:
               steps:
                - task: PowerShell@2
                  inputs:
                    filePath: '$(Agent.BuildDirectory)/s/scripts/Blaise/InstallBlaise.ps1'

                - task: PowerShell@2
                  displayName: Update Cati Database
                  inputs:
                    filePath: '$(Agent.BuildDirectory)/s/scripts/SQL/CatiDatabaseUpdate.ps1'

       - deployment: upgradeBlaise
         displayName: Upgrade Blaise
         environment: ${{parameters.Environment }}.BLAISE-GUSTY-NODE
         dependsOn: CheckIfBlaiseIsInstalled
         condition: eq(dependencies.CheckIfBlaiseIsInstalled.outputs['Deploy_BLAISE-GUSTY-NODE.BlaiseVariables.UpgradeBlaise'], 'True')
         strategy:
          runOnce:
             deploy:
               steps:
                - task: PowerShell@2
                  inputs:
                    filePath: '$(Agent.BuildDirectory)/s/scripts/Blaise/UpgradeBlaise.ps1'
                  env: 
                    ENV_BLAISE_ADMIN_PASS: $(ENV_BLAISE_ADMIN_PASSWORD)

       - job: "SmokeTests"
         dependsOn: 
         - installBlaise
         - upgradeBlaise
         condition: and(in(dependencies.installBlaise.result, 'Succeeded', 'Skipped'), in(dependencies.upgradeBlaise.result, 'Succeeded', 'Skipped'))
         variables:
          ENV_BLAISE_SERVER_BINDING : $(ENV_BLAISE_EXTERNAL_SERVER_BINDING)
          ENV_BLAISE_SERVER_HOST_NAME : $(ENV_BLAISE_EXTERNAL_SERVER_HOST_NAME)
         pool: 
          vmImage: 'windows-latest'
         steps: 
         - task: DownloadSecureFile@1
           displayName: 'Download GCP Key'
           name: gcpkey
           inputs:
              secureFile: 'ons-blaise-v2-shared-221e50eb36c7.json'

         - task: DownloadSecureFile@1
           displayName: 'Download blaise registry file'
           name: BlaiseRegistrySettings
           inputs:
              secureFile: blaise.reg

         - powershell: |
            regedit /i /s $(BlaiseRegistrySettings.secureFilePath)	
           displayName: 'Register Blaise License'

         - task: PowerShell@2
           displayName: Download test instrument
           inputs:
              targetType: 'inline'
              script: |
                Write-Host "Login to GCP"
                    gcloud auth activate-service-account $env:ENV_SHARED_SERVICE_ACCOUNT --key-file=$(gcpkey.secureFilePath)
                    
                    Write-Host "Downloading instrument"
                    gsutil cp gs://$env:ENV_SHARED_BUCKET/$env:InstrumentName.bpkg c:\survey\$env:InstrumentName.bpkg

         - task: VisualStudioTestPlatformInstaller@1
           displayName: Install Visual Studio Test Platform
           inputs:
              packageFeedSelector: 'nugetOrg'
              versionSelector: 'latestPreRelease'
              
         - task: DownloadBuildArtifacts@0
           displayName: Download latest Automated tests binaries
           inputs:
              buildType: 'specific'
              project: 'fbaf94f7-2d40-410a-8a27-de142d8d2313'
              pipeline: '43'
              buildVersionToDownload: 'latestFromBranch'
              branchName: 'refs/heads/master'
              downloadType: 'single'
              artifactName: '_AutomatedTests'
              downloadPath: '$(System.ArtifactsDirectory)'

         - task: replacetokens@3
           displayName: Replace config settings
           inputs:
              rootDirectory: '$(System.ArtifactsDirectory)' 
              targetFiles: '**/*Behaviour*.config'
              encoding: 'auto'
              writeBOM: true
              actionOnMissing: 'warn'
              keepToken: false
              tokenPrefix: '#{'
              tokenSuffix: '}#'
              useLegacyPattern: false
              enableTelemetry: true

         - task: VSTest@2
           displayName: 'Run Blaise Smoke Tests'
           inputs:
             searchFolder: '$(System.ArtifactsDirectory)'
             testAssemblyVer2: |
              **\Blaise.Tests.Behaviour\**\Blaise.Tests.Behaviour.dll
              !**\obj\**
              resultsFolder: '$(System.DefaultWorkingDirectory)\TestResults'
             runOnlyImpactedTests: false
             uiTests: true
             vsTestVersion: toolsInstaller
             runInParallel: false
             runTestsInIsolation: false
             codeCoverageEnabled: false
             testRunTitle: 'Instrument Test'
           continueOnError: false

  - stage: RestApi_${{parameters.Environment }}
    displayName: Installation Of RestAPI ${{parameters.Environment }}
    variables:
          ENV_RESTAPI_URL: http://localhost:90
          ENV_BLAISE_SERVER_BINDING : $(ENV_BLAISE_INTERNAL_SERVER_BINDING)
          TEMP_PATH : c:\blaise\temp
          PACKAGE_EXTENSION : bpkg
    jobs:
       - deployment: InstallRestAPI
         displayName: Install Rest API
         environment: ${{parameters.Environment }}.RESTAPI
         strategy:
          runOnce:
             deploy:
               steps:
               - checkout: self 
               - task: DownloadSecureFile@1
                 displayName: 'Download GCP Key'
                 name: gcpkey
                 inputs:
                  secureFile: 'ons-blaise-v2-shared-221e50eb36c7.json'
              
               - task: PowerShell@2
                 displayName: Download Test instrument
                 inputs:
                  targetType: 'inline'
                  script: |
                    Write-Host "Login to GCP"
                    gcloud auth activate-service-account $env:ENV_SHARED_SERVICE_ACCOUNT --key-file=$(gcpkey.secureFilePath)
                    
                    Write-Host "Downloading instrument"
                    gsutil cp gs://$env:ENV_SHARED_BUCKET/$env:InstrumentName.bpkg c:\survey\$env:InstrumentName.bpkg

                        Write-Host "GCP Login with compute service account"
                        gcloud auth login $env:ENV_VM_SERVICEACCOUNT

               - task: DownloadSecureFile@1
                 displayName: 'Download Blaise Registry settings file'
                 name: BlaiseRegistrySettings
                 inputs:
                   secureFile: blaise.reg

               - powershell: |
                  regedit /i /s $(BlaiseRegistrySettings.secureFilePath)	
                 displayName: 'Register Blaise License'
                
               - task: DownloadBuildArtifacts@0
                 displayName: Download REST API Artifact
                 inputs:
                  buildType: 'specific'
                  project: 'fbaf94f7-2d40-410a-8a27-de142d8d2313'
                  pipeline: '45'
                  buildVersionToDownload: 'latestFromBranch'
                  branchName: 'refs/heads/master'
                  downloadType: 'single'
                  artifactName: '_blaiseRestAPI'
                  downloadPath: '$(System.ArtifactsDirectory)'
                
               - task: replacetokens@3
                 displayName: Replace Config Settings
                 inputs:
                  rootDirectory: '$(System.ArtifactsDirectory)'
                  targetFiles: '**/*.config'
                  encoding: 'auto'
                  writeBOM: true
                  actionOnMissing: 'warn'
                  keepToken: false
                  tokenPrefix: '#{'
                  tokenSuffix: '}#'
                  useLegacyPattern: false
                  enableTelemetry: true
              
               - task: PowerShell@2
                 displayName: Deleting Current REST API Service
                 inputs:
                  filePath: '$(Agent.BuildDirectory)/s/scripts/delete-a-service.ps1'
                  arguments: '-ServiceName BlaiseRestApi'

               - task: CopyFiles@2
                 displayName: Copy REST API Binaries
                 inputs:
                  SourceFolder: '$(System.ArtifactsDirectory)/_BlaiseRestApi/Blaise.Api/bin/Release'
                  Contents: '**'
                  TargetFolder: 'c:\blaiseServices\BlaiseRestApi'
                  CleanTargetFolder: true
                  OverWrite: true

               - task: PowerShell@2
                 displayName: Create REST API Service
                 inputs:
                  filePath: '$(Agent.BuildDirectory)/s/scripts/create-a-service.ps1'
                  arguments: '-ServiceName BlaiseRestApi -exeName blaise.api'

               - task: VisualStudioTestPlatformInstaller@1
                 displayName: Install VS Test Platform
                 inputs:
                   packageFeedSelector: 'nugetOrg'
                   versionSelector: 'latestPreRelease'
                  
               - task: VSTest@2
                 condition: notin('${{ parameters.Environment }}', 'prod', 'preprod')
                 displayName: Run REST API Smoke Tests
                 inputs:
                   testSelector: 'testAssemblies'
                   testAssemblyVer2: |
                     **\Blaise.Api.Tests.Behaviour\**\Blaise.Api.Tests.Behaviour.dll
                     !**\obj\**
                   searchFolder: '$(System.ArtifactsDirectory)'
                   vsTestVersion: 'toolsInstaller'
                   testFiltercriteria: TestCategory=smoke
                
               - task: VSTest@2
                 condition: in('${{ parameters.Environment }}', 'prod', 'preprod')
                 displayName: Run REST API Full Integration Tests
                 inputs:
                   testSelector: 'testAssemblies'
                   testAssemblyVer2: |
                     **\Blaise.Api.Tests.Behaviour\**\Blaise.Api.Tests.Behaviour.dll
                     !**\obj\**
                   searchFolder: '$(System.ArtifactsDirectory)'
                   vsTestVersion: 'toolsInstaller'
                  
  - stage: Configure_Blaise_${{parameters.Environment}}_
    displayName: Configure Blaise ${{parameters.Environment}}_
    variables:
          ENV_RESTAPI_URL: http://localhost:90
          ENV_BLAISE_SERVER_BINDING : $(ENV_BLAISE_INTERNAL_SERVER_BINDING)

    jobs: 
        - deployment: CheckUserRolesAlreadyExist
          displayName: Check User Roles already exist
          environment: ${{parameters.Environment }}.RESTAPI
          strategy:
           runOnce: 
             deploy:
               steps:
               - checkout: self

               - task: PowerShell@2
                 name: DoUserRolesExist
                 displayName: Check User Roles already exist
                 inputs:
                  filePath: '$(Agent.BuildDirectory)/s/scripts/UserRoles/CheckUserRolesAlreadyExist.ps1'
                
        - deployment: CreateUserRoles
          displayName: Create User Roles
          environment: ${{parameters.Environment }}.RESTAPI
          dependsOn: CheckUserRolesAlreadyExist
          condition: eq(dependencies.CheckUserRolesAlreadyExist.outputs['Deploy_RESTAPI.DoUserRolesExist.UserRolesExist'], 'False')          
          strategy:
           runOnce: 
             deploy:
               steps:
               - checkout: self

               - task: PowerShell@2
                 displayName: Create User Roles
                 inputs:
                  filePath: '$(Agent.BuildDirectory)/s/scripts/UserRoles/CreateUserRoles.ps1'
              
        - deployment: CheckUserRolesAreCreated
          displayName: Check User Roles Are Created
          environment: ${{parameters.Environment }}.RESTAPI
          dependsOn: CreateUserRoles
          condition: eq(dependencies.CreateUserRoles.outputs['Deploy_RESTAPI.DoUserRolesExist.UserRolesExist'], 'False')
          strategy:
           runOnce: 
             deploy:
               steps:
               - checkout: self

               - task: PowerShell@2
                 displayName: Check User Roles have been created
                 inputs:
                  filePath: '$(Agent.BuildDirectory)/s/scripts/UserRoles/CheckUserRolesAreCreated.ps1'
                
  - stage: RunUISmokeTests
    displayName: Run UI Smoke Tests
    variables:
          ENV_BLAISE_SERVER_BINDING : $(ENV_BLAISE_EXTERNAL_SERVER_BINDING)
          ENV_BLAISE_SERVER_HOST_NAME : $(ENV_BLAISE_EXTERNAL_SERVER_HOST_NAME)
    jobs:
       - job: "UISmokeTests"
         pool: 
          vmImage: 'windows-latest'
         
         steps: 
         - task: DownloadSecureFile@1
           displayName: 'Download GCP Key'
           name: gcpkey
           inputs:
              secureFile: 'ons-blaise-v2-shared-221e50eb36c7.json'
         
         - task: DownloadSecureFile@1
           displayName: 'Download blaise registry file'
           name: BlaiseRegistrySettings
           inputs:
              secureFile: blaise.reg

         - powershell: |
            regedit /i /s $(BlaiseRegistrySettings.secureFilePath)	
           displayName: 'Register Blaise License'  

         - task: PowerShell@2
           displayName: Download test instrument
           inputs:
              targetType: 'inline'
              script: |
                Write-Host "Login to GCP"
                    gcloud auth activate-service-account $env:ENV_SHARED_SERVICE_ACCOUNT --key-file=$(gcpkey.secureFilePath)
                    
                    Write-Host "Downloading instrument"
                    gsutil cp gs://$env:ENV_SHARED_BUCKET/$env:InstrumentName.bpkg c:\survey\$env:InstrumentName.bpkg

         - task: VisualStudioTestPlatformInstaller@1
           displayName: Install Visual Studio Test Platform
           inputs:
              packageFeedSelector: 'nugetOrg'
              versionSelector: 'latestPreRelease'                       
              
         - task: DownloadBuildArtifacts@0
           displayName: Download latest Automated tests binaries
           inputs:
              buildType: 'specific'
              project: 'fbaf94f7-2d40-410a-8a27-de142d8d2313'
              pipeline: '43'
              buildVersionToDownload: 'latestFromBranch'
              branchName: 'refs/heads/master'
              downloadType: 'single'
              artifactName: '_AutomatedTests'
              downloadPath: '$(System.ArtifactsDirectory)'

         - task: replacetokens@3
           displayName: Replace config settings
           inputs:
              rootDirectory: '$(System.ArtifactsDirectory)' 
              targetFiles: '**/*.config'
              encoding: 'auto'
              writeBOM: true
              actionOnMissing: 'warn'
              keepToken: false
              tokenPrefix: '#{'
              tokenSuffix: '}#'
              useLegacyPattern: false
              enableTelemetry: true  
         
         - task: VSTest@2
           condition: notin('${{ parameters.Environment }}', 'prod', 'preprod')
           displayName: 'Run TOBI Smoke Tests'
           inputs:
             searchFolder: '$(System.ArtifactsDirectory)'
             testAssemblyVer2: |
              **\Blaise.tobi.tests.Behaviour\**\Blaise.tobi.tests.Behaviour.dll
              !**\obj\**
              resultsFolder: '$(System.DefaultWorkingDirectory)\TestResults'
             runOnlyImpactedTests: false
             uiTests: true
             vsTestVersion: toolsInstaller
             runInParallel: false
             runTestsInIsolation: false
             codeCoverageEnabled: false
             testRunTitle: 'TOBI Test'
             testFiltercriteria: TestCategory=smoke
           continueOnError: false
        
         - task: VSTest@2
           condition: in('${{ parameters.Environment }}', 'prod', 'preprod')
           displayName: 'Run TOBI Full Integration Tests'
           inputs:
             searchFolder: '$(System.ArtifactsDirectory)'
             testAssemblyVer2: |
              **\Blaise.tobi.tests.Behaviour\**\Blaise.tobi.tests.Behaviour.dll
              !**\obj\**
              resultsFolder: '$(System.DefaultWorkingDirectory)\TestResults'
             runOnlyImpactedTests: false
             uiTests: true
             vsTestVersion: toolsInstaller
             runInParallel: false
             runTestsInIsolation: false
             codeCoverageEnabled: false
             testRunTitle: 'TOBI Test'
           continueOnError: false

         - task: VSTest@2
           condition: notin('${{ parameters.Environment }}', 'prod', 'preprod')
           displayName: 'Run DQS Smoke Tests'
           inputs:
             searchFolder: '$(System.ArtifactsDirectory)'
             testAssemblyVer2: |
              **\Blaise.DQS.tests.Behaviour\**\Blaise.DQS.tests.Behaviour.dll
              !**\obj\**
              resultsFolder: '$(System.DefaultWorkingDirectory)\TestResults'
             runOnlyImpactedTests: false
             uiTests: true
             vsTestVersion: toolsInstaller
             runInParallel: false
             runTestsInIsolation: false
             codeCoverageEnabled: false
             testRunTitle: 'DQS Test'
             testFiltercriteria: TestCategory=smoke
           continueOnError: false
        
         - task: VSTest@2
           condition: in('${{ parameters.Environment }}', 'prod', 'preprod')
           displayName: 'Run DQS Full Integration Tests'
           inputs:
             searchFolder: '$(System.ArtifactsDirectory)'
             testAssemblyVer2: |
              **\Blaise.DQS.tests.Behaviour\**\Blaise.DQS.tests.Behaviour.dll
              !**\obj\**
              resultsFolder: '$(System.DefaultWorkingDirectory)\TestResults'
             runOnlyImpactedTests: false
             uiTests: true
             vsTestVersion: toolsInstaller
             runInParallel: false
             runTestsInIsolation: false
             codeCoverageEnabled: false
             testRunTitle: 'DQS Test'
           continueOnError: false
        
         - task: VSTest@2
           condition: notin('${{ parameters.Environment }}', 'prod', 'preprod')
           displayName: 'Run CATI Smoke Tests'
           inputs:
             searchFolder: '$(System.ArtifactsDirectory)'
             testAssemblyVer2: |
              **\Blaise.cati.tests.behaviour\**\Blaise.cati.tests.behaviour.dll
              !**\obj\**
              resultsFolder: '$(System.DefaultWorkingDirectory)\TestResults'
             runOnlyImpactedTests: false
             uiTests: true
             vsTestVersion: toolsInstaller
             runInParallel: false
             runTestsInIsolation: false
             codeCoverageEnabled: false
             testRunTitle: 'CATI Test'
             testFiltercriteria: TestCategory=smoke
           continueOnError: false

         - task: VSTest@2
           condition: in('${{ parameters.Environment }}', 'prod', 'preprod')
           displayName: 'Run CATI Full Integration Tests'
           inputs:
             searchFolder: '$(System.ArtifactsDirectory)'
             testAssemblyVer2: |
              **\Blaise.cati.tests.behaviour\**\Blaise.cati.tests.behaviour.dll
              !**\obj\**
              resultsFolder: '$(System.DefaultWorkingDirectory)\TestResults'
             runOnlyImpactedTests: false
             uiTests: true
             vsTestVersion: toolsInstaller
             runInParallel: false
             runTestsInIsolation: false
             codeCoverageEnabled: false
             testRunTitle: 'CATI Test'
           continueOnError: false

