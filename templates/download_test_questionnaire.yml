---
steps:
  - task: PowerShell@2
    displayName: Download test questionnaire
    inputs:
      targetType: inline
      script: |
        try {
          Write-Host "âš™ï¸ Starting GCP authentication with shared project service account..."
          # Clean up any old shared-config if present
          if (gcloud config configurations list --format="value(name)" | Select-String -Quiet "shared-config") {
            Write-Host "ğŸ§¹ Existing shared-config found, deleting..."
            gcloud config configurations delete shared-config --quiet
          } else {
            Write-Host "âœ… No existing shared-config found"
          }
          # Create and activate new shared-config
          Write-Host "ğŸ†• Creating and activating shared-config..."
          gcloud config configurations create shared-config --activate --quiet
          # Authenticate with service account
          Write-Host "ğŸ” Authenticating with service account $env:ENV_SHARED_SERVICE_ACCOUNT"
          gcloud auth activate-service-account $env:ENV_SHARED_SERVICE_ACCOUNT   --quiet
          Write-Host "â“ What is happening..."
          gcloud auth list
          gcloud auth describe $(gcloud auth list --format="value(account)" --filter="status:ACTIVE")
          # Download test questionnaire package
          Write-Host "ğŸ“¦ Downloading test questionnaire package..."
          Write-Host "ğŸŒ Source: gs://$env:ENV_SHARED_BUCKET/$env:QuestionnaireName.bpkg"
          Write-Host "ğŸ“ Destination: c:\survey\$env:QuestionnaireName.bpkg"
          gsutil cp gs://$env:ENV_SHARED_BUCKET/$env:QuestionnaireName.bpkg c:\survey\$env:QuestionnaireName.bpkg
          Write-Host "âœ… Test questionnaire package downloaded successfully!"
        }
        catch {
          Write-Host "ğŸš¨ ERROR during test questionnaire package download!"
          Write-Error "âŒ Exception details: $_"
          exit 1
        }
        finally {
          Write-Host "ğŸ” Reverting GCP authentication back to VM service account..."
          # Check if default config exists
          if (-not (gcloud config configurations list --format="value(name)" | Select-String -Quiet "default")) {
            Write-Host "âš ï¸ No default configuration found, creating it now..."
            gcloud config configurations create default --quiet
          } else {
            Write-Host "âœ… Default configuration already exists"
          }
          Write-Host "ğŸ”„ Activating default configuration..."
          gcloud config configurations activate default --quiet
          # Delete shared-config safely
          if (gcloud config configurations list --format="value(name)" | Select-String -Quiet "shared-config") {
            Write-Host "ğŸ§¹ Cleaning up temporary shared-config..."
            gcloud config configurations delete shared-config --quiet
          } else {
            Write-Host "âœ… No shared-config left to delete"
          }
          Write-Host "ğŸ Authentication restored to default service account"
        }
