---
steps:
  - task: DownloadSecureFile@1
    displayName: Download test questionnaire from Azure DevOps
    name: testQuestionnaire
    inputs:
      secureFile: '$(QuestionnaireName).bpkg'
      retryCount: 3
  - task: PowerShell@2
    displayName: Copy questionnaire to survey directory
    inputs:
      targetType: inline
      script: |
        try {
          Write-Host "ğŸ“¦ Copying test questionnaire to survey directory..."
          
          # The downloaded file path is in the variable $(testQuestionnaire.secureFilePath)
          Copy-Item -Path "$(testQuestionnaire.secureFilePath)" `
            -Destination "c:\survey\$env:QuestionnaireName.bpkg" `
            -Force
          
          Write-Host "âœ… Test questionnaire package copied successfully!"
        }
        catch {
          Write-Host "ğŸš¨ ERROR during test questionnaire package copy!"
          Write-Error "âŒ Exception details: $_"
          exit 1
        }
        finally {
          Write-Host "ğŸ” Reverting GCP authentication back to VM service account..."
          # Check if default config exists
          if (-not (gcloud config configurations list --format="value(name)" | Select-String -Quiet "default")) {
            Write-Host "âš ï¸ No default configuration found, creating it now..."
            gcloud config configurations create default --quiet
          } else {
            Write-Host "âœ… Default configuration already exists"
          }
          Write-Host "ğŸ”„ Activating default configuration..."
          gcloud config configurations activate default --quiet
          # Delete shared-config safely
          if (gcloud config configurations list --format="value(name)" | Select-String -Quiet "shared-config") {
            Write-Host "ğŸ§¹ Cleaning up temporary shared-config..."
            gcloud config configurations delete shared-config --quiet
          } else {
            Write-Host "âœ… No shared-config left to delete"
          }
          Write-Host "ğŸ Authentication restored to default service account"
        }