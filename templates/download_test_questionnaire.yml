---
steps:
  - task: PowerShell@2
    displayName: Download test questionnaire
    inputs:
      targetType: inline
      script: |
        try {
          Write-Host "ğŸ“¦ Downloading test questionnaire using service account impersonation..."
          
          # Set impersonation for the current session
          gcloud config set auth/impersonate_service_account $env:ENV_SHARED_SERVICE_ACCOUNT
          
          # Download using the impersonated account
          gsutil cp gs://$env:ENV_SHARED_BUCKET/$env:QuestionnaireName.bpkg `
            c:\survey\$env:QuestionnaireName.bpkg
          
          Write-Host "âœ… Test questionnaire package downloaded successfully!"
        }
        catch {
          Write-Host "ğŸš¨ ERROR during test questionnaire package download!"
          Write-Error "âŒ Exception details: $_"
          exit 1
        }
        finally {
          Write-Host "ğŸ” Reverting GCP authentication back to VM service account..."
          # Check if default config exists
          if (-not (gcloud config configurations list --format="value(name)" | Select-String -Quiet "default")) {
            Write-Host "âš ï¸ No default configuration found, creating it now..."
            gcloud config configurations create default --quiet
          } else {
            Write-Host "âœ… Default configuration already exists"
          }
          Write-Host "ğŸ”„ Activating default configuration..."
          gcloud config configurations activate default --quiet
          # Delete shared-config safely
          if (gcloud config configurations list --format="value(name)" | Select-String -Quiet "shared-config") {
            Write-Host "ğŸ§¹ Cleaning up temporary shared-config..."
            gcloud config configurations delete shared-config --quiet
          } else {
            Write-Host "âœ… No shared-config left to delete"
          }
          Write-Host "ğŸ Authentication restored to default service account"
        }