---
steps:
  - checkout: self
    persistCredentials: true
  - task: PowerShell@2
    env:
      SYSTEM_ACCESSTOKEN: ${{ parameters.SYSTEM_ACCESSTOKEN }}
    displayName: Download CMA packages
    inputs:
      targetType: inline
      script: |
        try {
          Write-Host "‚öôÔ∏è Starting GCP authentication with shared project service account..."
          # Clean up any old shared-config if present
          
          if (gcloud config configurations list --format="value(name)" | Select-String -Quiet "shared-config") {
            Write-Host "üßπ Existing shared-config found, deleting..."
            gcloud config configurations delete shared-config --quiet
          } else {
            Write-Host "‚úÖ No existing shared-config found"
          }
          
          
          # Authenticate with service account using WIF
          Write-Host "üîê Authenticating with service account $env:ENV_SHARED_SERVICE_ACCOUNT"


          $serviceConnectionId = "blaise-azure-wif-connection"

          $oidcUrl = "$($env:SYSTEM_COLLECTIONURI)$($env:SYSTEM_TEAMPROJECTID)/_apis/distributedtask/hubs/$($env:SYSTEM_HOSTTYPE)/plans/$($env:SYSTEM_PLANID)/jobs/$($env:SYSTEM_JOBID)/oidctoken?serviceConnectionId=$serviceConnectionId&api-version=7.2-preview.1"
          #$oidcUrl = "$($env:SYSTEM_TEAMFOUNDATIONCOLLECTIONURI)$env:SYSTEM_TEAMPROJECTID/_apis/build/definitions/$($env:SYSTEM_DEFINITIONID)?api-version=4.1-preview"

          Write-Host "SYSTEM_ACCESSTOKEN: $env:SYSTEM_ACCESSTOKEN" 
          Write-Host "üìå Requesting OIDC token from Azure DevOps..."

          $response = Invoke-RestMethod -Method Post `
              -Uri $oidcUrl `
              -Headers @{
                  "Authorization" = "Bearer $env:SYSTEM_ACCESSTOKEN"
                  "Content-Type" = "application/json"
              }

          $oidcToken = $response.oidcToken
          Write-Host "‚úÖ OIDC Token retrieved successfully!"
          $parts = $oidcToken -split '\.'
          $payload = $parts[1]

          # Base64 decode payload
          $decoded = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($payload + ('=' * ((4 - $payload.Length % 4) % 4))))

          Write-Host "OIDC payload: $decoded"

          if (-not $oidcToken) {
              Write-Error "‚ùå Could not fetch OIDC token"
              exit 1
          }


          $wifJson = "$env:TEMP\gcp-wif.json"
          $tokenFile = "$env:TEMP\token.jwt"

          # --- CLEAN UP OLD FILES FIRST ---
          Remove-Item $wifJson    -ErrorAction SilentlyContinue
          Remove-Item $tokenFile  -ErrorAction SilentlyContinue
          
          # Write SYSTEM_ACCESSTOKEN to file for WIF
          Set-Content -Path $tokenFile -Value $oidcToken

          # WIF external account JSON
          $audience = "//iam.googleapis.com/projects/2727969180/locations/global/workloadIdentityPools/azure-devops-identity-pool/providers/azure-wif-provider-2"
          $sa = $env:ENV_SHARED_SERVICE_ACCOUNT
          $service_account_impersonation_url = "https://iamcredentials.googleapis.com/v1/projects/2727969180/serviceAccounts/$($sa):generateAccessToken"
            
          Write-Host "Shared SA"
          Write-Host $sa
          Write-Host "Impersonation URL"
          Write-Host $service_account_impersonation_url  


          $wifConfig = @{
            type = "external_account"
            audience = $audience
            subject_token_type = "urn:ietf:params:oauth:token-type:jwt"
            token_url = "https://sts.googleapis.com/v1/token"
            service_account_impersonation_url = $service_account_impersonation_url
            credential_source = @{
                file = $tokenFile
                format = @{
                    type = "text"
                }
            }
          }

          $configJson = $wifConfig | ConvertTo-Json -Depth 10
          Write-Host "WIF Config JSON:"
          Write-Host $configJson
          
          $configJson | Set-Content -Path $wifJson -Encoding UTF8
          
          gcloud auth login --cred-file "$wifJson"

          # Test by listing storage buckets
          gcloud auth list

          # # Create and activate new shared-config
          # Write-Host "üÜï Creating and activating shared-config..."
          # & gcloud config configurations create shared-config --quiet
          # & gcloud config configurations activate shared-config --quiet

          # Write-Host "Point ADC to this JSON"
          # $env:GOOGLE_APPLICATION_CREDENTIALS = $wifJson
          # # $env:GOOGLE_APPLICATION_CREDENTIALS="C:\Windows\TEMP\gcp-wif.json"
          # # Test access token
          # # $token = & gcloud auth application-default print-access-token
          # # Write-Host "Token length: $($token.Length)"

          # Download CMA multi package
          Write-Host "üì¶ Downloading CMA multi package..."
          Write-Host "üåê Source: gs://$env:ENV_SHARED_BUCKET/$env:ENV_CMA_MULTI_PACKAGE"
          Write-Host "üìÅ Destination: C:\CMA\CMA-MULTI.zip"
          & gsutil cp "gs://$env:ENV_SHARED_BUCKET/$env:ENV_CMA_MULTI_PACKAGE" "C:\CMA\CMA-MULTI.zip"
          Write-Host "‚úÖ CMA multi package downloaded successfully!"
        }
        catch {
          Write-Host "üö® ERROR during CMA package download!"
          Write-Error "‚ùå Exception details: $_"
          exit 1
        }
        finally {
          Write-Host "üîÅ Reverting GCP authentication back to VM service account..."
          # Check if default config exists
          if (-not (gcloud config configurations list --format="value(name)" | Select-String -Quiet "default")) {
            Write-Host "‚ö†Ô∏è No default configuration found, creating it now..."
            gcloud config configurations create default --quiet
          } else {
            Write-Host "‚úÖ Default configuration already exists"
          }
          Write-Host "üîÑ Activating default configuration..."
          gcloud config configurations activate default --quiet
          # Delete shared-config safely
          if (gcloud config configurations list --format="value(name)" | Select-String -Quiet "shared-config") {
            Write-Host "üßπ Cleaning up temporary shared-config..."
            gcloud config configurations delete shared-config --quiet
          } else {
            Write-Host "‚úÖ No shared-config left to delete"
          }
          Write-Host "üèÅ Authentication restored to default service account"
        }
