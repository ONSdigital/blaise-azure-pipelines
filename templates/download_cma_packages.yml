---
steps:
  - checkout: self
    persistCredentials: true
  - task: PowerShell@2
    env:
      SYSTEM_ACCESSTOKEN: ${{ parameters.SYSTEM_ACCESSTOKEN }}
    displayName: Download CMA packages
    inputs:
      targetType: inline
      script: |
        if (-not $env:SYSTEM_ACCESSTOKEN) {
          Write-Error "OAuth token not found. Ensure token permissions are enabled."
          exit 1
        }
        try {
          Write-Host "‚öôÔ∏è Starting GCP authentication with shared project service account..."
          # Clean up any old shared-config if present
          
          if (gcloud config configurations list --format="value(name)" | Select-String -Quiet "shared-config") {
            Write-Host "üßπ Existing shared-config found, deleting..."
            gcloud config configurations delete shared-config --quiet
          } else {
            Write-Host "‚úÖ No existing shared-config found"
          }
          # Create and activate new shared-config
          Write-Host "üÜï Creating and activating shared-config..."
          gcloud config configurations create shared-config --activate --quiet
          
          # Authenticate with service account using WIF
          Write-Host "üîê Authenticating with service account $env:ENV_SHARED_SERVICE_ACCOUNT"

          # Write SYSTEM_ACCESSTOKEN to file for WIF
          $env:AZURE_FEDERATED_TOKEN = "$env:TEMP\token.jwt"
          Set-Content -Path $env:AZURE_FEDERATED_TOKEN -Value $env:SYSTEM_ACCESSTOKEN

          Write-Host "System access token valid or not?"
          Write-Host "Token length: $($env:SYSTEM_ACCESSTOKEN.Length)"

          Write-Host "Azure federated token valid or not?"
          Write-Host "$env:AZURE_FEDERATED_TOKEN"

          
          # WIF external account JSON
          $audience = "//iam.googleapis.com/projects/ons-blaise-v2-shared/locations/global/workloadIdentityPools/azure-devops-identity-pool/providers/azure-wif-provider"
          $sa = $env:ENV_SHARED_SERVICE_ACCOUNT

          $config = @{
            type = "external_account"
            audience = $audience
            subject_token_type = "urn:ietf:params:oauth:token-type:jwt"
            token_url = "https://sts.googleapis.com/v1/token"
            service_account_impersonation_url = "https://iamcredentials.googleapis.com/v1/projects/ons-blaise-v2-shared/serviceAccounts/$sa:generateAccessToken"
            credential_source = @{
              environment_id = "azure"
              file = ${env:AZURE_FEDERATED_TOKEN}
            }
          }

          $path = "$env:TEMP\gcp-wif.json"
          $configJson = $config | ConvertTo-Json -Compress
          Set-Content -Path $path -Value $configJson

          # Point ADC to this WIF JSON
          $env:GOOGLE_APPLICATION_CREDENTIALS = $path

          Write-Host "gcloud version:"
          gcloud --version

          Write-Host "Downloading latest Google Cloud SDK installer..."
          $installer = "$env:TEMP\GoogleCloudSDKInstaller.exe"

          Invoke-WebRequest -Uri "https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe" -OutFile $installer

          Write-Host "Installing Google Cloud SDK silently..."
          Start-Process $installer -ArgumentList "/S" -Wait

          Write-Host "New Google Cloud SDK version:"
          gcloud --version

          Write-Host "Active gcloud version:"
          Get-Command gcloud | Select-Object Source, Version


          Write-Host "Agent Name: $env:AGENT_NAME"
          Write-Host "Agent OS: $env:AGENT_OS"
          Write-Host "Machine Name: $env:COMPUTERNAME"
          Write-Host "Running as user: $env:USERNAME"

          Write-Host "Activate new gcloud version:"
          # ---- Locate NEW GCLOUD + GSUTIL binaries ----
          $NewGcloud = "C:\Program Files\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"
          $NewGsutil  = "C:\Program Files\Google\Cloud SDK\google-cloud-sdk\bin\gsutil.cmd"

          if (-Not (Test-Path $NewGcloud)) {
              Write-Error "‚ùå NEW gcloud binary not found! Installation failed."
              exit 1
          }

          Write-Host "‚úî Using NEW gcloud binary: $NewGcloud"
          & $NewGcloud --version


          # Download CMA multi package
          Write-Host "üì¶ Downloading CMA multi package..."
          Write-Host "üåê Source: gs://$env:ENV_SHARED_BUCKET/$env:ENV_CMA_MULTI_PACKAGE"
          Write-Host "üìÅ Destination: C:\CMA\CMA-MULTI.zip"
          gcloud auth application-default login --cred-file="$path" --quiet
          gcloud auth list
          gcloud auth application-default print-access-token
          gsutil cp gs://$env:ENV_SHARED_BUCKET/$env:ENV_CMA_MULTI_PACKAGE "C:\CMA\CMA-MULTI.zip"
          Write-Host "‚úÖ CMA multi package downloaded successfully!"
        }
        catch {
          Write-Host "üö® ERROR during CMA package download!"
          Write-Error "‚ùå Exception details: $_"
          exit 1
        }
        finally {
          Write-Host "üîÅ Reverting GCP authentication back to VM service account..."
          # Check if default config exists
          if (-not (gcloud config configurations list --format="value(name)" | Select-String -Quiet "default")) {
            Write-Host "‚ö†Ô∏è No default configuration found, creating it now..."
            gcloud config configurations create default --quiet
          } else {
            Write-Host "‚úÖ Default configuration already exists"
          }
          Write-Host "üîÑ Activating default configuration..."
          gcloud config configurations activate default --quiet
          # Delete shared-config safely
          if (gcloud config configurations list --format="value(name)" | Select-String -Quiet "shared-config") {
            Write-Host "üßπ Cleaning up temporary shared-config..."
            gcloud config configurations delete shared-config --quiet
          } else {
            Write-Host "‚úÖ No shared-config left to delete"
          }
          Write-Host "üèÅ Authentication restored to default service account"
        }
