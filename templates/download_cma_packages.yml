---
steps:
  - checkout: self
    persistCredentials: true
  - task: PowerShell@2
    env:
      SYSTEM_ACCESSTOKEN: ${{ parameters.SYSTEM_ACCESSTOKEN }}
    displayName: Download CMA packages
    inputs:
      targetType: inline
      script: |
        try {

          Write-Host "âš™ï¸ Starting GCP authentication with WIF using SA impersonation..."

          Write-Host "ğŸ” Authenticating with service account $env:ENV_SHARED_SERVICE_ACCOUNT"

          $serviceConnectionId = "blaise-azure-wif-connection"

          $oidcUrl = "$($env:SYSTEM_COLLECTIONURI)$($env:SYSTEM_TEAMPROJECTID)/_apis/distributedtask/hubs/$($env:SYSTEM_HOSTTYPE)/plans/$($env:SYSTEM_PLANID)/jobs/$($env:SYSTEM_JOBID)/oidctoken?api-version=7.2-preview.1"
           
          Write-Host "ğŸ“Œ Requesting OIDC token from Azure DevOps..."

          $response = Invoke-RestMethod -Method Post `
              -Uri $oidcUrl `
              -Headers @{
                  "Authorization" = "Bearer $env:SYSTEM_ACCESSTOKEN"
                  "Content-Type" = "application/json"
              }

          $oidcToken = $response.oidcToken
          Write-Host "âœ… Azure OIDC Token retrieved successfully!"
          $parts = $oidcToken -split '\.'
          $payload = $parts[1]

          # Base64 decode payload
          $decoded = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($payload + ('=' * ((4 - $payload.Length % 4) % 4))))

          Write-Host "OIDC payload: $decoded"

          if (-not $oidcToken) {
              Write-Error "âŒ Could not fetch OIDC token"
              exit 1
          }


          $wifJson = "$env:TEMP\gcp-wif.json"
          $tokenFile = "$env:TEMP\token.jwt"
          
          # Write Azure OIDC token to file for WIF
          Set-Content -Path $tokenFile -Value $oidcToken

          # Prepare WIF external account JSON

          $audience = "//iam.googleapis.com/projects/2727969180/locations/global/workloadIdentityPools/azure-devops-identity-pool/providers/azure-wif-provider-2"
          $sa = $env:ENV_SHARED_SERVICE_ACCOUNT
          $service_account_impersonation_url = "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$($sa):generateAccessToken"
            
          $wifConfig = @{
            type = "external_account"
            audience = $audience
            subject_token_type = "urn:ietf:params:oauth:token-type:jwt"
            token_url = "https://sts.googleapis.com/v1/token"
            service_account_impersonation_url = $service_account_impersonation_url
            credential_source = @{
                file = $tokenFile
            }
          }

          $configJson = $wifConfig | ConvertTo-Json -Depth 10
          $configJson | Set-Content -Path $wifJson -Encoding UTF8

          gcloud auth login --cred-file=$wifJson --quiet

          # 3. Impersonate the service account
          gcloud auth print-identity-token --impersonate-service-account=$sa --quiet

          # Download CMA multi package
          Write-Host "ğŸ“¦ Downloading CMA multi package..."
          Write-Host "ğŸŒ Source: gs://$env:ENV_SHARED_BUCKET/$env:ENV_CMA_MULTI_PACKAGE"
          Write-Host "ğŸ“ Destination: C:\CMA\CMA-MULTI.zip"
          gcloud storage cp gs://$env:ENV_SHARED_BUCKET/$env:ENV_CMA_MULTI_PACKAGE "C:\CMA\CMA-MULTI.zip"
          Write-Host "âœ… CMA multi package downloaded successfully!"
        }
        catch {
          Write-Host "ğŸš¨ ERROR during CMA package download!"
          Write-Error "âŒ Exception details: $_"
          exit 1
        }
        finally {

          # -----------------------------
          # 1ï¸âƒ£ Revoke the WIF account (if present)
          # -----------------------------

          Write-Host "ğŸ”‘ Revoking WIF account: $sa"
          try {
            & gcloud auth revoke $account --quiet 2>$null
          } catch {
            Write-Host "âš ï¸ Ignoring non-zero exit from gcloud auth revoke (expected for service accounts)"
          }
          
          # -----------------------------
          # 2ï¸âƒ£ Clear all credential artifacts
          # -----------------------------

          $gcloudDir = Join-Path $env:USERPROFILE ".config\gcloud"
          $paths = @(
              "$gcloudDir\credentials.db",
              "$gcloudDir\application_default_credentials.json",
              "$gcloudDir\configurations\*.tmp",
              "$gcloudDir\legacy_credentials"
          )

          Write-Host "ğŸ§½ Removing residual credential files..."
          foreach ($p in $paths) {
              Remove-Item $p -Recurse -Force -ErrorAction SilentlyContinue
          }

          # -----------------------------
          # 3ï¸âƒ£ Clear GOOGLE_APPLICATION_CREDENTIALS env override
          # -----------------------------
          if ($env:GOOGLE_APPLICATION_CREDENTIALS) {
              Write-Host "â™»ï¸ Clearing GOOGLE_APPLICATION_CREDENTIALS override..."
              Remove-Item Env:GOOGLE_APPLICATION_CREDENTIALS -ErrorAction SilentlyContinue
          }


          # -----------------------------
          # 4ï¸âƒ£ Ensure 'default' config exists & activate it
          # -----------------------------
          Write-Host "ğŸ”§ Ensuring 'default' gcloud config exists..."

          if (-not (gcloud config configurations list --format="value(name)" | Select-String -Quiet "default")) {
            Write-Host "âš ï¸ No default configuration found, creating it now..."
            gcloud config configurations create default --quiet
          } else {
            Write-Host "âœ… Default configuration already exists"
          }
          Write-Host "ğŸ”„ Activating default configuration..."
          gcloud config configurations activate default --quiet
          Write-Host "ğŸ Authentication restored to default service account"
          
          # -----------------------------
          # 5ï¸âƒ£ Final validation
          # -----------------------------
          Write-Host "ğŸ“¡ Testing access token (should be metadata server)..."

          $token = gcloud auth print-access-token 2>$null

          if ($LASTEXITCODE -eq 0 -and $token.Length -gt 100) {
              Write-Host "âœ… SUCCESS: VM is now using the metadata server service account"
          } else {
              Write-Host "âŒ ERROR: Token retrieval failed. gcloud may still be misconfigured."
              Write-Host "ğŸ‘‰ Try restarting gcloud or reloading the VM's metadata service."
          }

          Write-Host "âœ¨ Cleanup complete."
          
        }
